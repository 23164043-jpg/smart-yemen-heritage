// ====== ููู: assistantService.js (ูุณุงุนุฏ ุฐูู ูุน Gemini AI) ======

require('dotenv').config();
const axios = require('axios');

// ================== ูุงุนุฏุฉ ูุนุฑููุฉ ุนู ุชุงุฑูุฎ ุงูููู ุงููุฏูู ==================
const yemenKnowledge = {
  kingdoms: {
    "ุณุจุฃ": "ููููุฉ ุณุจุฃ ูู ูู ุฃุนุธู ุงูููุงูู ุงูููููุฉ ุงููุฏููุฉุ ุงุฒุฏูุฑุช ูู ุงููุฑู ุงูุซุงูู ูุจู ุงููููุงุฏ ุญุชู ุงููุฑู ุงูุซุงูุซ ุงููููุงุฏู. ุนุงุตูุชูุง ูุฃุฑุจุ ูุงุดุชูุฑุช ุจุณุฏ ูุฃุฑุจ ุงูุนุธูู ูุชุฌุงุฑุฉ ุงูุจุฎูุฑ ูุงููุจุงู. ุฐููุฑุช ูู ุงููุฑุขู ุงููุฑูู ูุงุฑุชุจุทุช ุจูุตุฉ ุงููููุฉ ุจูููุณ ูุน ุงููุจู ุณูููุงู.",
    "ุญููุฑ": "ููููุฉ ุญููุฑ (110 ู.ู - 525 ู) ูู ุขุฎุฑ ุงูููุงูู ุงูููููุฉ ุงููุฏููุฉ ุงููุจุฑู. ูุญูุฏุช ุงูููู ุชุญุช ุญูููุง ูุฌุนูุช ุธูุงุฑ ุนุงุตูุฉ ููุง.",
    "ูุนูู": "ููููุฉ ูุนูู (1200-650 ู.ู) ูู ุฃูุฏู ุงูููุงูู ุงูููููุฉุ ุนุงุตูุชูุง ูุฑูุงู.",
    "ูุชุจุงู": "ููููุฉ ูุชุจุงู (500 ู.ู - 50 ู) ุนุงุตูุชูุง ุชููุน.",
    "ุญุถุฑููุช": "ููููุฉ ุญุถุฑููุช ุงููุฏููุฉ ุงุดุชูุฑุช ุจุฅูุชุงุฌ ุงููุจุงูุ ุนุงุตูุชูุง ุดุจูุฉ."
  },

  landmarks: {
    "ุณุฏ ูุฃุฑุจ": "ุณุฏ ูุฃุฑุจ ุฃุนุธู ุฅูุฌุงุฒ ููุฏุณู ูู ุงูููู ุงููุฏููุ ุจููู ูู ุงููุฑู ุงูุซุงูู ูุจู ุงููููุงุฏ.",
    "ูุนุจุฏ ุฃูุงู": "ูุนุจุฏ ุฃูุงู (ูุญุฑู ุจูููุณ) ูุฎุตุต ููุฅูู ุงูููู.",
    "ุนุฑุด ุจูููุณ": "ูุนุจุฏ ุจุฑุงู ูู ูุฃุฑุจุ ูุชููุฒ ุจุฃุนูุฏุชู ุงูุฎูุณุฉ.",
    "ุดุจุงู": "ุดุจุงู ุญุถุฑููุช ุชูููุจ ุจูุงููุงุชู ุงูุตุญุฑุงุก.",
    "ุตูุนุงุก ุงููุฏููุฉ": "ุตูุนุงุก ุงููุฏููุฉ ูู ุฃูุฏู ุงููุฏู ุงููุฃูููุฉ ูู ุงูุนุงูู.",
    "ุฏุงุฑ ุงูุญุฌุฑ": "ุฏุงุฑ ุงูุญุฌุฑ ูุตุฑ ุตุฎุฑู ูู ูุงุฏู ุธูุฑ.",
    "ุจุงุจ ุงูููู": "ุจุงุจ ุงูููู ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ ูุตูุนุงุก ุงููุฏููุฉ."
  },

  figures: {
    "ุจูููุณ": "ุงููููุฉ ุจูููุณ ูููุฉ ุณุจุฃ ุงูุดููุฑุฉ.",
    "ูุฑุจ ุฅู ูุชุฑ": "ูุฑุจ ุฅู ูุชุฑ ูู ุฃุนุธู ูููู ุณุจุฃ.",
    "ุดูุฑ ููุฑุนุด": "ุดูุฑ ููุฑุนุด ููู ุญููุฑู ูุญูุฏ ุงูููู."
  },
  
  // ุงููุชุงุจุฉ ูุงูุซูุงูุฉ
  culture: {
    "ุงููุณูุฏ": "ุฎุท ุงููุณูุฏ ูู ุงูุฎุท ุงููููู ุงููุฏูู.",
    "ุงููุจุงู": "ุงููุจุงู ูู ุฃูู ุตุงุฏุฑุงุช ุงูููู ุงููุฏูู.",
    "ุทุฑูู ุงูุจุฎูุฑ": "ุทุฑูู ุชุฌุงุฑู ูุฏูู ูููู ุงูุจุฎูุฑ."
  }
};

// ================== ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ ==================
function searchKnowledge(query) {
  let results = [];
  const lowerQuery = query.toLowerCase();
  for (const category of Object.values(yemenKnowledge)) {
    for (const [key, value] of Object.entries(category)) {
      if (key.includes(lowerQuery) || value.includes(lowerQuery)) {
        results.push({ topic: key, info: value });
      }
    }
  }
  return results;
}

// ================== ุงูุฑุฏูุฏ ุงูุนุงูุฉ ุงูุซุงุจุชุฉ ==================
const generalResponses = {
  greeting: "ูุฑุญุจุงู! ๐ ุฃูุง ุงููุณุงุนุฏ ุงูุฐูู ูููุณูุนุฉ ุชุงุฑูุฎ ุงูููู ุงููุฏูู ๐๏ธ ููู ูููููู ูุณุงุนุฏุชู ุงููููุ",
  help: "ููููู ุณุคุงูู ุนู ุงูููุงูู (ุณุจุฃุ ุญููุฑ..)ุ ุงููุนุงูู ุงูุฃุซุฑูุฉุ ุงูุดุฎุตูุงุช ุงูุชุงุฑูุฎูุฉุ ุฃู ุฃู ุดูุก ูุฎุต ุญุถุงุฑุฉ ุงูููู ุงูุนุฑููุฉ."
};

// ================== Gemini AI ==================
async function askGemini(question, knowledgeContext = "") {
  try {
    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      console.error("โ Error: GEMINI_API_KEY is missing in .env file");
      return null;
    }

    // ุจูุงุก ุงูู Prompt ููููู ุฏูููุงู
    const fullPrompt = `
ุฃูุช "ูุณุงุนุฏ ุชุงุฑูุฎ ุงูููู"ุ ุฎุจูุฑ ูุฏูุฏ ูู ุงูุญุถุงุฑุฉ ุงูููููุฉ ุงููุฏููุฉ.
ููุงุนุฏู:
1. ุงุณุชุฎุฏู ุงููุนูููุงุช ุงูุชุงููุฉ ุฅุฐุง ูุงูุช ูููุฏุฉ: ${knowledgeContext}
2. ุฃุฌุจ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุจุฃุณููุจ ูุดูู.
3. ุฅุฐุง ุณูุฆูุช ุนู ุดูุก ูุนุงุตุฑ (ูุซู ุนุงุตูุฉ ุงูููู ุงูุญุงููุฉ)ุ ุฃุฌุจ ุจุฐูุงุก ูุน ุฑุจุทูุง ุจุงูุชุงุฑูุฎ ุฅู ุฃููู.
4. ุณุคุงู ุงููุณุชุฎุฏู ูู: ${question}
`;

    // ุงุณุชุฎุฏุงู ููุฏูู gemini-pro ุงููุณุชูุฑ
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;

    const response = await axios.post(
      apiUrl,
      {
        contents: [{ parts: [{ text: fullPrompt }] }],
        generationConfig: { temperature: 0.7, maxOutputTokens: 800 }
      },
      { headers: { 'Content-Type': 'application/json' }, timeout: 15000 }
    );

    // ุงูุชุญูู ูู ุตุญุฉ ุงูุฑุฏ
    if (response.data && response.data.candidates && response.data.candidates[0].content) {
      return response.data.candidates[0].content.parts[0].text;
    }
    
    return null;

  } catch (err) {
    // ุทุจุงุนุฉ ุชูุงุตูู ุงูุฎุทุฃ ูู ุงูู Terminal ูููุทูุฑ
    if (err.response) {
      console.error("โ Gemini API Error:", err.response.data);
    } else {
      console.error("โ Connection Error:", err.message);
    }
    return null;
  }
}

// ================== ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ ==================
module.exports = {
  ask: async function (message) {
    if (!message) return "ูู ูุถูู ุฃุฑุณู ุณุคุงูุงู.";
    const query = message.trim();

    // 1. ูุญุต ุงูุชุญูุงุช
    if (/^(ูุฑุญุจุง|ููุง|ุงูุณูุงู|ุตุจุงุญ|ูุณุงุก|hello|hi)/i.test(query)) {
      return generalResponses.greeting;
    }

    // 2. ูุญุต ุทูุจ ุงููุณุงุนุฏุฉ
    if (/^(ุณุงุนุฏ|help|ููู|ูุงุฐุง ุชูุนู)/i.test(query)) {
      return generalResponses.help;
    }

    // 3. ุงูุจุญุซ ุงููุญูู ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ
    const localResults = searchKnowledge(query);
    let context = "";
    if (localResults.length > 0) {
      context = localResults.map(r => `${r.topic}: ${r.info}`).join("\n");
      // ุฅุฐุง ูุงู ุงูุณุคุงู ูุตูุฑุงู ููุทุงุจูุงู ุชูุงูุงูุ ููุชูู ุจุงูุฑุฏ ุงููุญูู
      if (query.length < 10) {
          return `๐ **${localResults[0].topic}**\n\n${localResults[0].info}`;
      }
    }

    // 4. ุงุณุชุดุงุฑุฉ Gemini (ุณูุงุก ูุฌุฏูุง ูุนูููุงุช ูุญููุฉ ูุชุนุฒูุฒ ุงูุฅุฌุงุจุฉ ุฃู ูู ูุฌุฏ)
    const geminiResponse = await askGemini(query, context);
    if (geminiResponse) {
      return geminiResponse;
    }

    // 5. ูู ุญุงูุฉ ูุดู ูู ุดูุก
    return "ุนุฐุฑุงูุ ูุงุฌูุช ูุดููุฉ ูู ุงูุงุชุตุงู ุจุนููู ุงูุงุตุทูุงุนู. ูู ููููู ุชูุฑุงุฑ ุงูุณุคุงูุ ๐";
  }
};